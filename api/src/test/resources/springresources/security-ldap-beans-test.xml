<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:security="http://www.springframework.org/schema/security"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
                        http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-2.0.4.xsd">

	<!--

		Usernames/Passwords are rod/koala dianne/emu scott/wombat
		<security:ldap-server id="embedded" root="dc=springframework,dc=org"
		      ldif="classpath:ldap/users.ldif" port="7000" />
	-->


	<!--
		Not all users are in the same node
		<security:ldap-authentication-provider
		group-search-filter="member={0}" group-search-base="ou=groups"
		user-search-base="ou=people" user-search-filter="uid={0}"
		server-ref="embedded" user-dn-pattern="uid={0},ou=people" />
	-->

	<bean id="contextSource"
		class="org.springframework.security.ldap.DefaultSpringSecurityContextSource">
		<!--
		<constructor-arg value="ldap://10.60.21.157/dc=bcn,dc=abiquo,dc=com" />
			catalog :3268
		-->
			<constructor-arg
			value="ldap://localhost:7007/dc=springframework,dc=org" />
		<!-- <property name="base" value="CN=Users,dc=agileworks,dc=com"/> 
		<property name="referral" value="follow"/>
		<property name="baseEnvironmentProperties">
			<map>
				<entry key="java.naming.ldap.version" value="3" />
				<entry key="Context.SECURITY_AUTHENTICATION" value="simple" />
			</map>
		</property>
		-->

	</bean>
	<bean id="ldapAuthProvider"
		class="com.abiquo.api.spring.security.authentication.providers.ldap.LdapAbiquoAuthenticationProvider">
		<!--
			class="org.springframework.security.providers.ldap.LdapAuthenticationProvider">
		-->
		<constructor-arg>
			<ref bean="ldapAuthenticator" />
		</constructor-arg>
		<constructor-arg>
			<ref bean="ldapAuthorities" />
		</constructor-arg>
		<security:custom-authentication-provider />
	</bean>
	<bean id="ldapAuthenticator"
		class="com.abiquo.api.spring.security.authentication.LdapAbiquoAuthenticatorImpl">
		<!--
			class="org.springframework.security.providers.ldap.authenticator.BindAuthenticator">
		-->
		<constructor-arg>
			<ref bean="contextSource" />
		</constructor-arg>
		<property name="contextFactory" ref="contextSource" />
		<!-- 
		 -->
		<property name="userSearch">
			<bean id="userSearch"
				class="org.springframework.security.ldap.search.FilterBasedLdapUserSearch">
				<constructor-arg index="0" value="" />
				<constructor-arg index="1"
					value="(&amp;(objectClass=user)(sAMAccountName={0}))" />
				<constructor-arg index="2" ref="contextSource" />
			</bean>
		</property>
		<property name="userDnPatterns">
			<list>
				<value>uid={0},ou=people</value>
				<value>sAMAccountName={0}</value>
				<value>cn={0},CN=Users</value>
				<value>uid={0}</value>
			</list>
		</property>
		<!--		<property name="principalPrefix" value="BCN" />-->
	</bean>
	<bean id="ldapAuthorities"
		class="com.abiquo.api.spring.security.authentication.populator.LdapAbiquoAuthoritiesPopulator">
		<constructor-arg ref="contextSource" />
		<constructor-arg value="" />
		<property name="groupRoleAttribute" value="cn" />
		<property name="groupSearchFilter" value="member={0}" />
	</bean>


	<!--
		<bean id="ldapTemplate"
		class="org.springframework.security.ldap.SpringSecurityLdapTemplate">
		<constructor-arg ref="contextSource" /> </bean> <bean
		id="contextSource"
		class="org.springframework.security.ldap.DefaultSpringSecurityContextSource">
		<constructor-arg
		value="ldap://localhost:7004/dc=springframework,dc=org" /> </bean>

		<bean id="ldapAuthProvider"
		class="org.springframework.security.providers.ldap.LdapAuthenticationProvider">
		<constructor-arg> <bean
		class="org.springframework.security.providers.ldap.authenticator.BindAuthenticator">
		<constructor-arg ref="contextSource" /> <property name="userSearch">
		<bean id="userSearch"
		class="org.springframework.security.ldap.search.FilterBasedLdapUserSearch">
		<constructor-arg index="0" value="ou=people" /> <constructor-arg
		index="1" value="(uid={0})" /> <constructor-arg index="2"
		ref="contextSource" /> </bean> </property> <property
		name="userDnPatterns"> <list> <value>uid={0},ou=people</value> </list>
		</property> </bean> </constructor-arg> <constructor-arg> <bean
		class="org.springframework.security.ldap.populator.DefaultLdapAuthoritiesPopulator">
		<constructor-arg ref="contextSource" /> <constructor-arg
		value="ou=groups" /> <property name="groupRoleAttribute" value="ou" />
		</bean> </constructor-arg> </bean>
	-->
</beans>
